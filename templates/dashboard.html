{% extends 'base.html' %}

{% block title %}Dashboard - Inventory Pro{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block breadcrumb %}
<a href="/"><i class="fas fa-home"></i> Dashboard</a>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">Total Products</span>
      <div class="stat-icon primary">
        <i class="fas fa-tag"></i>
      </div>
    </div>
    <div class="stat-value" data-stat="total_products">{{ total_products }}</div>
    <div class="stat-change positive">
      <i class="fas fa-arrow-up"></i> Active inventory
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">Total Stores</span>
      <div class="stat-icon success">
        <i class="fas fa-store"></i>
      </div>
    </div>
    <div class="stat-value" data-stat="total_stores">{{ total_stores }}</div>
    <div class="stat-change positive">
      <i class="fas fa-arrow-up"></i> Locations
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">Low Stock Alerts</span>
      <div class="stat-icon {% if low_stock_count > 0 %}warning{% else %}success{% endif %}">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
    </div>
    <div class="stat-value" data-stat="low_stock_count">{{ low_stock_count }}</div>
    <div class="stat-change {% if low_stock_count > 0 %}negative{% else %}positive{% endif %}">
      <i class="fas fa-{% if low_stock_count > 0 %}exclamation{% else %}check{% endif %}-circle"></i> 
      {% if low_stock_count > 0 %}Needs attention{% else %}All good{% endif %}
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <span class="stat-title">Inventory Value</span>
      <div class="stat-icon primary">
        <i class="fas fa-dollar-sign"></i>
      </div>
    </div>
    <div class="stat-value" data-stat="total_value">₹{{ "%.2f"|format(total_value or 0) }}</div>
    <div class="stat-change positive">
      <i class="fas fa-chart-line"></i> Total worth
    </div>
  </div>
</div>

<!-- Dashboard Content -->
<div class="row">
  <!-- Main Charts -->
  <div class="col-8">
    <!-- Low Stock Alerts (if any) -->
    <div class="card alert-card" id="lowStockAlert" style="display: none;">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
          <i class="fas fa-exclamation-triangle"></i> Low Stock Alerts
        </h5>
      </div>
      <div class="card-body">
        <div id="lowStockList">
          <!-- Low stock items will be loaded here -->
        </div>
        <div class="text-center mt-3">
          <button class="btn btn-warning btn-sm" onclick="viewAllAlerts()">
            <i class="fas fa-list"></i> View All Alerts
          </button>
          <button class="btn btn-success btn-sm" onclick="generateReorderList()">
            <i class="fas fa-shopping-cart"></i> Generate Reorder List
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Inventory Overview</h3>
      </div>
      <div class="card-body">
        <div style="height: 300px;">
          <canvas id="inventoryChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Top Products by Quantity</h3>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table data-table="true">
            <thead>
              <tr>
                <th data-sortable="true">Product</th>
                <th data-sortable="true">SKU</th>
                <th data-sortable="true" data-sort="number">Total Quantity</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for product in top_products %}
              <tr>
                <td>{{ product.name }}</td>
                <td><span class="badge">{{ product.sku }}</span></td>
                <td>{{ product.total_quantity or 0 }}</td>
                <td>
                  {% if product.total_quantity and product.total_quantity > 0 %}
                    <span class="text-success"><i class="fas fa-check-circle"></i> In Stock</span>
                  {% else %}
                    <span class="text-danger"><i class="fas fa-exclamation-circle"></i> Out of Stock</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="col-4">
    <!-- Quick Actions -->
    <div class="card">
      <div class="card-header">
        <h3>Quick Actions</h3>
      </div>
      <div class="card-body">
        <div class="d-flex flex-column gap-2">
          <a href="/products" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Product
          </a>
          <a href="/stores" class="btn btn-secondary">
            <i class="fas fa-store"></i> Manage Stores
          </a>
          <a href="/inventory" class="btn btn-success">
            <i class="fas fa-warehouse"></i> Bulk Update
          </a>
          <a href="/reports" class="btn btn-info">
            <i class="fas fa-chart-bar"></i> View Reports
          </a>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="card">
      <div class="card-header">
        <h3>Recent Transactions</h3>
      </div>
      <div class="card-body">
        <div class="activity-list">
          {% for transaction in recent_transactions %}
          <div class="activity-item">
            <div class="activity-icon">
              {% if transaction.change > 0 %}
                <i class="fas fa-plus text-success"></i>
              {% else %}
                <i class="fas fa-minus text-danger"></i>
              {% endif %}
            </div>
            <div class="activity-content">
              <div class="activity-title">{{ transaction.product_name }}</div>
              <div class="activity-meta">
                {{ transaction.store_name }} • 
                {% if transaction.change > 0 %}+{% endif %}{{ transaction.change }} units
              </div>
              <div class="activity-time">{{ transaction.created_at }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="text-center mt-3">
          <a href="/transactions" class="btn btn-sm btn-secondary">View All Transactions</a>
        </div>
      </div>
    </div>

    <!-- System Status -->
    <div class="card">
      <div class="card-header">
        <h3>System Status</h3>
      </div>
      <div class="card-body">
        <div class="status-item">
          <div class="status-indicator success"></div>
          <span>Database Connected</span>
        </div>
        <div class="status-item">
          <div class="status-indicator success"></div>
          <span>Real-time Updates</span>
        </div>
        <div class="status-item">
          <div class="status-indicator {% if low_stock_count > 0 %}warning{% else %}success{% endif %}"></div>
          <span>Stock Levels {% if low_stock_count > 0 %}Need Attention{% else %}Normal{% endif %}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Dashboard specific styles */
.badge {
  background: var(--gray-100);
  color: var(--gray-700);
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  font-weight: 500;
}

.activity-list {
  max-height: 300px;
  overflow-y: auto;
}

.activity-item {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-md);
  padding: var(--spacing-md) 0;
  border-bottom: 1px solid var(--gray-100);
}

.activity-item:last-child {
  border-bottom: none;
}

.activity-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--gray-100);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.activity-content {
  flex: 1;
}

.activity-title {
  font-weight: 500;
  color: var(--gray-800);
  margin-bottom: var(--spacing-xs);
}

.activity-meta {
  font-size: var(--font-size-sm);
  color: var(--gray-600);
  margin-bottom: var(--spacing-xs);
}

.activity-time {
  font-size: var(--font-size-xs);
  color: var(--gray-400);
}

.status-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-sm) 0;
}

.status-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-indicator.success {
  background: var(--success-color);
}

.status-indicator.warning {
  background: var(--warning-color);
}

.status-indicator.danger {
  background: var(--danger-color);
}

.gap-2 {
  gap: var(--spacing-sm);
}

.flex-column {
  flex-direction: column;
}
</style>

<script>
// Dashboard specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
  // Initialize dashboard charts
  initDashboardCharts();
  
  // Load real-time data
  loadDashboardData();
  loadLowStockAlerts();
  
  // Set up auto-refresh for dashboard
  setInterval(() => {
    loadDashboardData();
    loadLowStockAlerts();
  }, 30000);
});

async function initDashboardCharts() {
  try {
    const response = await fetch('/api/analytics/dashboard');
    const data = await response.json();
    
    // Initialize inventory overview chart
    const ctx = document.getElementById('inventoryChart');
    if (ctx && window.Chart) {
      // Get data from DOM data attributes instead of inline template variables
      const totalProducts = parseInt(document.body.dataset.totalProducts) || 0;
      const lowStockCount = parseInt(document.body.dataset.lowStockCount) || 0;
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['In Stock', 'Low Stock', 'Out of Stock'],
          datasets: [{
            data: [
              Math.max(0, totalProducts - lowStockCount),
              lowStockCount,
              0
            ],
            backgroundColor: [
              '#48BB78',
              '#ED8936', 
              '#F56565'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            }
          }
        }
      });
    }
  } catch (error) {
    console.error('Failed to load dashboard charts:', error);
  }
}

async function loadDashboardData() {
  try {
    const response = await fetch('/api/report/summary');
    const data = await response.json();
    
    // Update the products table
    updateProductsTable(data);
  } catch (error) {
    console.error('Failed to load dashboard data:', error);
  }
}

function updateProductsTable(products) {
  const tbody = document.querySelector('table tbody');
  if (tbody) {
    tbody.innerHTML = '';
    
    products.slice(0, 5).forEach(product => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${product.name}</td>
        <td><span class="badge">${product.sku}</span></td>
        <td>${product.total_quantity || 0}</td>
        <td>
          ${product.total_quantity > 0 ? 
            '<span class="text-success"><i class="fas fa-check-circle"></i> In Stock</span>' :
            '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> Out of Stock</span>'
          }
        </td>
      `;
      tbody.appendChild(row);
    });
  }
}

async function loadLowStockAlerts() {
  try {
    const response = await fetch('/api/alerts/low-stock');
    const alerts = await response.json();
    
    const alertCard = document.getElementById('lowStockAlert');
    const alertList = document.getElementById('lowStockList');
    
    if (alerts.length === 0) {
      alertCard.style.display = 'none';
      return;
    }
    
    // Show only the most critical alerts (limit to 5)
    const criticalAlerts = alerts.slice(0, 5);
    
    alertList.innerHTML = criticalAlerts.map(alert => `
      <div class="alert-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded ${alert.alert_level === 'out_of_stock' ? 'border-danger' : 'border-warning'}">
        <div>
          <strong>${alert.product_name}</strong> (${alert.sku})
          <br>
          <small class="text-muted">
            <i class="fas fa-store"></i> ${alert.store_name} | 
            <span class="${alert.alert_level === 'out_of_stock' ? 'text-danger' : 'text-warning'}">
              ${alert.current_quantity} / ${alert.reorder_point || 0}
            </span>
          </small>
        </div>
        <div>
          <span class="badge badge-${alert.alert_level === 'out_of_stock' ? 'danger' : 'warning'}">
            ${alert.alert_level === 'out_of_stock' ? 'Out of Stock' : 'Low Stock'}
          </span>
          <button class="btn btn-sm btn-success ml-2" onclick="quickReorder(${alert.product_id}, ${alert.store_id})">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
    `).join('');
    
    alertCard.style.display = 'block';
    
  } catch (error) {
    console.error('Failed to load low stock alerts:', error);
  }
}

function viewAllAlerts() {
  // Navigate to inventory management with low stock filter
  window.location.href = '/inventory-management?filter=low-stock';
}

async function generateReorderList() {
  try {
    const response = await fetch('/api/alerts/reorder-suggestions');
    const suggestions = await response.json();
    
    if (suggestions.length === 0) {
      alert('No reorder suggestions at this time');
      return;
    }
    
    // Create a simple reorder list display
    let reorderText = 'REORDER SUGGESTIONS\\n\\n';
    suggestions.forEach(item => {
      reorderText += `${item.product_name} (${item.sku})\\n`;
      reorderText += `  Store: ${item.store_name}\\n`;
      reorderText += `  Current: ${item.current_quantity}, Suggested: ${item.suggested_quantity}\\n`;
      reorderText += `  Supplier: ${item.supplier_name || 'None'}\\n\\n`;
    });
    
    // For now, show in alert. In production, this could generate a PDF or CSV
    if (confirm('Reorder suggestions ready. Would you like to view them?')) {
      const newWindow = window.open();
      newWindow.document.write(`
        <html>
          <head><title>Reorder Suggestions</title></head>
          <body style="font-family: monospace; white-space: pre-wrap; padding: 20px;">
            ${reorderText.replace(/\\n/g, '<br>')}
          </body>
        </html>
      `);
    }
    
  } catch (error) {
    console.error('Failed to generate reorder list:', error);
    alert('Failed to generate reorder suggestions');
  }
}

async function quickReorder(productId, storeId) {
  const quantity = prompt('Enter quantity to add:');
  if (!quantity || parseInt(quantity) <= 0) return;
  
  try {
    const response = await fetch('/api/inventory/add-stock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: storeId,
        product_id: productId,
        quantity: parseInt(quantity),
        notes: 'Quick reorder from dashboard alert',
        user_id: 'user'
      })
    });
    
    if (response.ok) {
      const result = await response.json();
      alert(`Successfully added ${quantity} units!`);
      loadLowStockAlerts(); // Refresh alerts
      loadDashboardData(); // Refresh stats
    } else {
      const error = await response.json();
      alert(error.error || 'Failed to add stock');
    }
  } catch (error) {
    console.error('Quick reorder error:', error);
    alert('Failed to add stock');
  }
}
</script>

<style>
.alert-card {
  border-left: 4px solid #ffc107;
}

.alert-item {
  transition: background-color 0.3s ease;
}

.alert-item:hover {
  background-color: #f8f9fa;
}

.badge-danger {
  background-color: #dc3545;
  color: white;
}

.badge-warning {
  background-color: #ffc107;
  color: #212529;
}

.border-danger {
  border-color: #dc3545 !important;
}

.border-warning {
  border-color: #ffc107 !important;
}
</style>
{% endblock %}