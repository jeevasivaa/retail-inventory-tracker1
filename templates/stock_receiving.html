{% extends 'base.html' %}

{% block title %}Stock Receiving - Inventory Pro{% endblock %}
{% block page_title %}Stock Receiving{% endblock %}

{% block content %}
<div class="stock-receiving">
  <!-- Action Bar -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-0">Stock Receiving</h3>
      <p class="text-muted">Receive stock from suppliers and manage purchase orders</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-secondary" data-action="create-po">
        <i class="fas fa-file-plus"></i> Create PO
      </button>
      <button class="btn btn-primary" data-action="receive-stock">
        <i class="fas fa-truck"></i> Receive Stock
      </button>
    </div>
  </div>

  <!-- Receiving Options -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card receiving-option" data-option="supplier">
        <div class="card-body text-center">
          <i class="fas fa-industry fa-3x text-primary mb-3"></i>
          <h5>From Supplier</h5>
          <p class="text-muted">Receive stock from a supplier with supplier details and costs</p>
          <button class="btn btn-primary" onclick="openSupplierReceiving()">
            <i class="fas fa-truck"></i> Receive from Supplier
          </button>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card receiving-option" data-option="transfer">
        <div class="card-body text-center">
          <i class="fas fa-exchange-alt fa-3x text-info mb-3"></i>
          <h5>Inter-Store Transfer</h5>
          <p class="text-muted">Receive stock transferred from another store location</p>
          <button class="btn btn-info" onclick="openTransferReceiving()">
            <i class="fas fa-exchange-alt"></i> Receive Transfer
          </button>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card receiving-option" data-option="adjustment">
        <div class="card-body text-center">
          <i class="fas fa-clipboard-check fa-3x text-success mb-3"></i>
          <h5>Stock Adjustment</h5>
          <p class="text-muted">Adjust stock levels due to count discrepancies or other reasons</p>
          <button class="btn btn-success" onclick="openAdjustmentReceiving()">
            <i class="fas fa-edit"></i> Adjust Stock
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Receiving History -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Recent Stock Receipts</h5>
    </div>
    <div class="card-body">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Reference</th>
              <th>Type</th>
              <th>Store</th>
              <th>Items</th>
              <th>Total Value</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="receivingHistoryBody">
            {% for receipt in recent_receipts %}
            <tr>
              <td>{{ receipt.date if receipt.date else '-' }}</td>
              <td>
                <span class="badge badge-secondary">{{ receipt.reference_number }}</span>
              </td>
              <td>
                <span class="receipt-type {{ receipt.type_class }}">
                  <i class="{{ receipt.type_icon }}"></i> {{ receipt.type_name }}
                </span>
              </td>
              <td>{{ receipt.store_name }}</td>
              <td>{{ receipt.item_count }} items</td>
              <td>â‚¹{{ "%.2f"|format(receipt.total_value or 0) }}</td>
              <td>
                <span class="badge badge-{{ receipt.status_class }}">{{ receipt.status }}</span>
              </td>
              <td>
                <button class="btn btn-sm btn-info" data-action="view-receipt" data-id="{{ receipt.id }}">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Supplier Receiving Modal -->
<div id="supplierReceivingModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3>Receive Stock from Supplier</h3>
      <span class="close" onclick="closeModal('supplierReceivingModal')">&times;</span>
    </div>
    <div class="modal-body">
      <form id="supplierReceivingForm">
        <!-- Receiving Header -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-label">Supplier *</label>
              <select class="form-control" id="receivingSupplier" required>
                <option value="">Select Supplier</option>
                {% for supplier in suppliers %}
                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-label">Destination Store *</label>
              <select class="form-control" id="receivingStore" required>
                <option value="">Select Store</option>
                {% for store in stores %}
                <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-label">Purchase Order #</label>
              <input type="text" class="form-control" id="receivingPO" placeholder="Optional">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-label">Invoice #</label>
              <input type="text" class="form-control" id="receivingInvoice" placeholder="Optional">
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-label">Delivery Date</label>
              <input type="date" class="form-control" id="receivingDate" value="{{ today }}">
            </div>
          </div>
        </div>

        <!-- Items Section -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Items Received</h6>
            <button type="button" class="btn btn-sm btn-primary" onclick="addReceivingItem()">
              <i class="fas fa-plus"></i> Add Item
            </button>
          </div>
          <div class="card-body">
            <div id="receivingItemsContainer">
              <div class="receiving-item row mb-3 p-3 border rounded">
                <div class="col-md-4">
                  <label class="form-label">Product</label>
                  <select class="form-control product-select" name="product_id" required>
                    <option value="">Select Product</option>
                    {% for product in products %}
                    <option value="{{ product.id }}">{{ product.sku }} - {{ product.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Quantity</label>
                  <input type="number" class="form-control" name="quantity" min="1" required>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Unit Cost</label>
                  <input type="number" class="form-control" name="unit_cost" step="0.01" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Notes</label>
                  <input type="text" class="form-control" name="notes" placeholder="Optional">
                </div>
                <div class="col-md-1">
                  <label class="form-label">&nbsp;</label>
                  <button type="button" class="btn btn-danger btn-sm" onclick="removeReceivingItem(this)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label class="form-label">Delivery Notes</label>
          <textarea class="form-control" id="receivingNotes" rows="3" 
                    placeholder="Additional notes about this delivery..."></textarea>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-secondary" onclick="closeModal('supplierReceivingModal')">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="processSupplierReceiving()">
            <i class="fas fa-check"></i> Process Receiving
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.receiving-option {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  cursor: pointer;
}

.receiving-option:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.receipt-type {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.875rem;
  font-weight: 500;
}

.receipt-type.supplier {
  background-color: #e3f2fd;
  color: #1976d2;
}

.receipt-type.transfer {
  background-color: #f3e5f5;
  color: #7b1fa2;
}

.receipt-type.adjustment {
  background-color: #e8f5e8;
  color: #388e3c;
}

.receiving-item {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6 !important;
}

.receiving-item:hover {
  background-color: #e9ecef;
}

.badge-secondary {
  background-color: #6c757d;
  color: white;
}

.badge-success {
  background-color: #28a745;
  color: white;
}

.badge-warning {
  background-color: #ffc107;
  color: #212529;
}

.badge-info {
  background-color: #17a2b8;
  color: white;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize receiving functionality
  initializeReceiving();
});

function initializeReceiving() {
  // Add event listeners for action buttons
  document.addEventListener('click', function(e) {
    if (e.target.closest('[data-action]')) {
      const button = e.target.closest('[data-action]');
      const action = button.dataset.action;
      
      switch(action) {
        case 'create-po':
          createPurchaseOrder();
          break;
        case 'receive-stock':
          openSupplierReceiving();
          break;
        case 'view-receipt':
          viewReceipt(button.dataset.id);
          break;
      }
    }
  });
}

function openSupplierReceiving() {
  document.getElementById('supplierReceivingModal').classList.add('show');
  document.body.style.overflow = 'hidden';
  
  // Set today's date
  document.getElementById('receivingDate').value = new Date().toISOString().split('T')[0];
}

function openTransferReceiving() {
  // Navigate to inventory management with transfer focus
  window.location.href = '/inventory-management';
}

function openAdjustmentReceiving() {
  // Navigate to inventory management with adjustment focus
  window.location.href = '/inventory-management';
}

function addReceivingItem() {
  const container = document.getElementById('receivingItemsContainer');
  const newItem = container.querySelector('.receiving-item').cloneNode(true);
  
  // Clear the values
  newItem.querySelectorAll('input, select').forEach(input => {
    input.value = '';
  });
  
  container.appendChild(newItem);
}

function removeReceivingItem(button) {
  const container = document.getElementById('receivingItemsContainer');
  if (container.children.length > 1) {
    button.closest('.receiving-item').remove();
  }
}

async function processSupplierReceiving() {
  const supplierId = document.getElementById('receivingSupplier').value;
  const storeId = document.getElementById('receivingStore').value;
  const poNumber = document.getElementById('receivingPO').value;
  const invoiceNumber = document.getElementById('receivingInvoice').value;
  const deliveryDate = document.getElementById('receivingDate').value;
  const notes = document.getElementById('receivingNotes').value;
  
  if (!supplierId || !storeId) {
    alert('Please select supplier and destination store');
    return;
  }
  
  // Collect items
  const items = [];
  const receivingItems = document.querySelectorAll('.receiving-item');
  
  receivingItems.forEach((item, index) => {
    const productId = item.querySelector('[name="product_id"]').value;
    const quantity = parseInt(item.querySelector('[name="quantity"]').value);
    const unitCost = parseFloat(item.querySelector('[name="unit_cost"]').value) || 0;
    const itemNotes = item.querySelector('[name="notes"]').value;
    
    if (productId && quantity > 0) {
      items.push({
        product_id: productId,
        quantity: quantity,
        unit_cost: unitCost,
        notes: itemNotes || `Supplier delivery item ${index + 1}`
      });
    }
  });
  
  if (items.length === 0) {
    alert('Please add at least one item to receive');
    return;
  }
  
  // Add supplier and reference information to each item
  const processedItems = items.map(item => ({
    ...item,
    store_id: storeId,
    supplier_id: supplierId,
    notes: `${item.notes} | PO: ${poNumber || 'N/A'} | Invoice: ${invoiceNumber || 'N/A'}`
  }));
  
  try {
    const response = await fetch('/api/inventory/bulk-add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ 
        items: processedItems,
        reference_type: 'supplier_receiving',
        reference_details: {
          supplier_id: supplierId,
          po_number: poNumber,
          invoice_number: invoiceNumber,
          delivery_date: deliveryDate,
          notes: notes
        }
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      closeModal('supplierReceivingModal');
      showNotification(`Supplier receiving completed! ${result.success_count} items processed.`, 'success');
      location.reload();
    } else {
      alert(result.error || 'Failed to process receiving');
    }
  } catch (error) {
    console.error('Error processing receiving:', error);
    alert('Failed to process receiving');
  }
}

function createPurchaseOrder() {
  alert('Purchase Order creation feature will be available in the next version');
}

function viewReceipt(receiptId) {
  // Navigate to transaction details or show receipt modal
  window.location.href = `/transactions?receipt=${receiptId}`;
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
  }
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} position-fixed`;
  notification.style.top = '20px';
  notification.style.right = '20px';
  notification.style.zIndex = '9999';
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}
</script>
{% endblock %}