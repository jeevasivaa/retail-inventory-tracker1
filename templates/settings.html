{% extends 'base.html' %}

{% block title %}Settings - Inventory Pro{% endblock %}
{% block page_title %}System Settings{% endblock %}

{% block breadcrumb %}
<a href="/"><i class="fas fa-home"></i> Dashboard</a>
<span>/</span>
<a href="/settings">Settings</a>
{% endblock %}

{% block content %}
<div class="row">
  <!-- System Settings -->
  <div class="col-8">
    <div class="card">
      <div class="card-header">
        <h4>System Configuration</h4>
      </div>
      <div class="card-body">
        <form id="settingsForm">
          <div class="row">
            {% for setting in settings %}
            <div class="col-6 mb-3">
              <label class="form-label">{{ setting.key|replace('_', ' ')|title }}</label>
              <input type="text" name="{{ setting.key }}" class="form-control" 
                     value="{{ setting.value }}" 
                     data-description="{{ setting.description or '' }}">
              {% if setting.description %}
              <small class="text-muted">{{ setting.description }}</small>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          
          <div class="d-flex justify-content-end mt-4">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Save Settings
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="col-4">
    <!-- Categories -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Categories</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          {% for category in categories %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>{{ category.name }}</span>
            <button class="btn btn-sm btn-danger" data-action="delete-category" data-category-id="{{ category.id }}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          {% endfor %}
        </div>
        
        <form id="addCategoryForm" class="d-flex gap-2">
          <input type="text" name="name" class="form-control form-control-sm" placeholder="Category name" required>
          <button type="submit" class="btn btn-sm btn-primary">Add</button>
        </form>
      </div>
    </div>

    <!-- Suppliers -->
    <div class="card">
      <div class="card-header">
        <h5>Suppliers</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          {% for supplier in suppliers %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="fw-bold">{{ supplier.name }}</div>
              {% if supplier.contact_email %}
              <small class="text-muted">{{ supplier.contact_email }}</small>
              {% endif %}
            </div>
            <button class="btn btn-sm btn-danger" data-action="delete-supplier" data-supplier-id="{{ supplier.id }}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          {% endfor %}
        </div>
        
        <form id="addSupplierForm">
          <input type="text" name="name" class="form-control form-control-sm mb-2" placeholder="Supplier name" required>
          <input type="email" name="contact_email" class="form-control form-control-sm mb-2" placeholder="Email (optional)">
          <button type="submit" class="btn btn-sm btn-primary">Add Supplier</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Settings page JavaScript
document.addEventListener('DOMContentLoaded', function() {
  initializeForms();
  
  // Add event delegation for delete actions
  document.addEventListener('click', function(e) {
    if (e.target.closest('[data-action]')) {
      const element = e.target.closest('[data-action]');
      const action = element.dataset.action;
      
      switch(action) {
        case 'delete-category':
          deleteCategory(element.dataset.categoryId);
          break;
        case 'delete-supplier':
          deleteSupplier(element.dataset.supplierId);
          break;
      }
      
      e.preventDefault();
    }
  });
});

function initializeForms() {
  // Settings form
  document.getElementById('settingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const settings = {};
    
    for (let [key, value] of formData.entries()) {
      settings[key] = value;
    }
    
    try {
      const response = await fetch('/api/settings/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
      });
      
      if (response.ok) {
        if (window.inventoryApp) {
          window.inventoryApp.showAlert('success', 'Settings saved successfully');
        } else {
          alert('Settings saved successfully');
        }
      } else {
        throw new Error('Failed to save settings');
      }
    } catch (error) {
      console.error('Settings save error:', error);
      if (window.inventoryApp) {
        window.inventoryApp.showAlert('error', 'Failed to save settings');
      } else {
        alert('Failed to save settings');
      }
    }
  });
  
  // Add category form
  document.getElementById('addCategoryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
      name: formData.get('name'),
      description: `Category: ${formData.get('name')}`
    };
    
    try {
      const response = await fetch('/api/category', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        if (window.inventoryApp) {
          window.inventoryApp.showAlert('success', 'Category added successfully');
        }
        setTimeout(() => location.reload(), 1000);
      } else {
        const error = await response.json();
        throw new Error(error.error || 'Failed to add category');
      }
    } catch (error) {
      console.error('Add category error:', error);
      if (window.inventoryApp) {
        window.inventoryApp.showAlert('error', error.message);
      } else {
        alert(error.message);
      }
    }
  });
  
  // Add supplier form
  document.getElementById('addSupplierForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
      name: formData.get('name'),
      contact_email: formData.get('contact_email') || ''
    };
    
    try {
      const response = await fetch('/api/supplier', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        if (window.inventoryApp) {
          window.inventoryApp.showAlert('success', 'Supplier added successfully');
        }
        setTimeout(() => location.reload(), 1000);
      } else {
        const error = await response.json();
        throw new Error(error.error || 'Failed to add supplier');
      }
    } catch (error) {
      console.error('Add supplier error:', error);
      if (window.inventoryApp) {
        window.inventoryApp.showAlert('error', error.message);
      } else {
        alert(error.message);
      }
    }
  });
}

async function deleteCategory(categoryId) {
  if (!confirm('Are you sure you want to delete this category?\\n\\nThis action cannot be undone and may affect products using this category.')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/category/${categoryId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok) {
      if (window.inventoryApp) {
        window.inventoryApp.showAlert('success', 'Category deleted successfully');
      } else {
        alert('Category deleted successfully');
      }
      setTimeout(() => location.reload(), 1000);
    } else {
      throw new Error(result.error || 'Failed to delete category');
    }
  } catch (error) {
    console.error('Delete category error:', error);
    alert(error.message);
  }
}

async function deleteSupplier(supplierId) {
  if (!confirm('Are you sure you want to delete this supplier?\\n\\nThis action cannot be undone and may affect products using this supplier.')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/supplier/${supplierId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok) {
      if (window.inventoryApp) {
        window.inventoryApp.showAlert('success', 'Supplier deleted successfully');
      } else {
        alert('Supplier deleted successfully');
      }
      setTimeout(() => location.reload(), 1000);
    } else {
      throw new Error(result.error || 'Failed to delete supplier');
    }
  } catch (error) {
    console.error('Delete supplier error:', error);
    alert(error.message);
  }
}
</script>

<style>
.fw-bold {
  font-weight: 600;
}
</style>
{% endblock %}